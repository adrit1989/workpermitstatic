<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE" async defer></script>
    
    <style>
        /* DEBUGGER STYLE */
        #debug-console { background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 10px; border-bottom: 2px solid red; max-height: 150px; overflow-y: scroll; display: none; }
        
        /* GLOBAL STYLES */
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .glass { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        input, select, textarea { width: 100%; border: 1px solid #d1d5db; padding: 10px 12px; border-radius: 8px; font-size: 1rem; background: #fff; margin-bottom: 0.5rem; }
        input:focus, select:focus, textarea:focus { border-color: #ea580c; outline: none; ring: 2px solid #fdba74; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
        .section-title { font-weight: 800; color: #c2410c; margin: 1.5rem 0 1rem 0; border-bottom: 2px solid #fdba74; padding-bottom: 0.5rem; font-size: 1.1rem; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5rem; color: #ea580c; font-weight: bold; flex-direction: column; gap: 10px; }
        
        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tr { display: block; margin-bottom: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; padding: 0.75rem 0; text-align: right; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: 600; color: #6b7280; text-align: left; margin-right: 1rem; }
            #actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 1rem; z-index: 100; flex-direction: column; gap: 0.5rem; }
            #actions button, #actions a { width: 100%; display: block; text-align: center; padding: 12px; font-size: 1.1rem; }
            #view-map { flex-direction: column; }
            #map-list { height: 35%; order: 2; width: 100%; border-top: 2px solid #ccc; }
            #map-container { height: 65%; order: 1; width: 100%; }
        }
        @media (min-width: 769px) {
            .desktop-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
            table.mobile-table { width: 100%; border-collapse: collapse; display: table; }
            table.mobile-table thead { display: table-header-group; background: #ea580c; color: white; }
            table.mobile-table tr { display: table-row; }
            table.mobile-table th { background: #ea580c; color: white; padding: 12px; text-align: left; }
            table.mobile-table td { display: table-cell; border-bottom: 1px solid #e5e7eb; padding: 12px; }
            table.mobile-table td::before { content: none; }
            #view-map { flex-direction: row; }
            #map-list { width: 350px; height: 100%; border-right: 1px solid #ddd; overflow-y: auto; }
            #map-container { flex: 1; height: 100%; }
        }
    </style>
</head>
<body>
    <div id="debug-console">waiting for logs...</div>

    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-600 mx-auto mb-2"></div>
        <div class="font-bold text-orange-600">Processing...</div>
    </div>

    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 bg-orange-50">
        <div class="glass w-full max-w-md text-center shadow-xl border-t-4 border-orange-600">
            <div class="flex justify-center items-center gap-4 mb-4">
                <img src="logo.png" alt="IOCL" class="h-24 object-contain">
                <img src="rhino.png" alt="Rhino" class="h-24 object-contain">
            </div>
            <h1 class="text-3xl font-extrabold text-orange-600 mb-2">IndianOil</h1>
            <p class="text-gray-500 mb-6 font-semibold">Mainline Permit System</p>
            <form onsubmit="event.preventDefault(); window.handleLogin();" class="space-y-4 text-left">
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Role</label><select id="login-role" class="w-full bg-gray-50 h-12" onchange="window.loadUserNames()"><option value="Requester">Requester</option><option value="Reviewer">Reviewer</option><option value="Approver">Approver</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">User</label><select id="login-name" class="w-full bg-gray-50 h-12" disabled><option>Loading Users...</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-50 h-12" value="12345"></div>
                <button class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg">Sign In</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-2 pb-24 hidden desktop-container">
        <div class="mb-4"><img src="safety_banner.png" class="w-full h-auto rounded-xl shadow-lg border-2 border-orange-600 object-cover"></div>
        <div class="flex justify-between items-center mb-4 bg-orange-600 p-4 rounded-xl shadow-lg text-white sticky top-2 z-40">
            <div class="flex items-center gap-3">
                <img src="logo.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <div class="flex flex-col"><h1 class="text-lg font-bold leading-tight">Permit System</h1><span id="user-info" class="text-xs text-orange-100 font-medium"></span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.toggleWorkerMode()" class="bg-white/20 p-2 rounded-lg" title="Workers">üë∑</button>
                <button onclick="window.showMap()" id="btn-header-map" class="bg-white/20 p-2 rounded-lg hidden" title="Map">üó∫Ô∏è</button>
                <button onclick="location.reload()" class="bg-white/20 p-2 rounded-lg" title="Logout">üö™</button>
            </div>
        </div>

        <div id="view-worker-management" class="hidden">
             <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Worker Management</h2><button onclick="window.toggleWorkerMode()" class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded">‚Üê Back</button></div>
             <div id="worker-form-container" class="glass hidden border-l-4 border-blue-500"><h3 class="font-bold mb-3 text-lg">Add/Edit Worker</h3><form onsubmit="event.preventDefault(); window.saveWorker(window.currentWorkerAction);" class="grid grid-cols-1 md:grid-cols-2 gap-3"><input type="hidden" id="w-id"><input id="w-name" placeholder="Full Name" required><input id="w-father" placeholder="Father's Name" required><input id="w-address" placeholder="Address"><input id="w-contact" placeholder="Contact No" type="tel">
             <div><select id="w-id-type" onchange="window.toggleOtherID()"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Any Other</option></select><input id="w-id-type-other" placeholder="Specify ID Type" class="hidden bg-yellow-50 mt-1"></div>
             <input id="w-idcard" placeholder="ID Number" required><select id="w-gender"><option>Male</option><option>Female</option></select><input id="w-age" type="number" placeholder="Age (18+)" min="18" required><button class="bg-green-600 text-white py-3 rounded-lg font-bold mt-2 shadow md:col-span-2">Save Worker</button></form></div>
             <button onclick="window.openWorkerForm('create')" id="btn-add-worker" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold mb-4 shadow hidden">+ Add New Worker</button>
             <table class="mobile-table w-full text-left text-sm" id="table-workers"><thead class="hidden md:table-header-group bg-gray-100 text-gray-700"><tr><th>Name</th><th>Father Name</th><th>ID</th><th>Address</th><th>Requestor</th><th>Status</th><th>Action</th></tr></thead><tbody class="divide-y divide-gray-200"></tbody></table>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Dashboard</h2><button onclick="window.showNewPermit()" id="btn-new-permit" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow hidden">+ New</button></div>
            <div class="grid grid-cols-3 gap-2 mb-4"><button onclick="window.showAddUser()" id="btn-add-user" class="bg-purple-100 text-purple-700 py-2 rounded font-bold text-sm hidden">Users</button><button onclick="window.showMap()" id="btn-view-map" class="bg-blue-100 text-blue-700 py-2 rounded font-bold text-sm hidden">Map</button><button onclick="window.open('/api/download-excel')" id="btn-download-excel" class="bg-green-100 text-green-700 py-2 rounded font-bold text-sm hidden">Excel</button></div>
            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden"><div class="glass h-64"><canvas id="chartStatus"></canvas></div><div class="glass h-64"><canvas id="chartType"></canvas></div></div>
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Action Required</h3><div class="mb-6"><table class="mobile-table w-full text-left text-sm" id="table-pending"><thead class="bg-red-50 text-red-900"><tr><th class="p-2">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Pending With</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Active / Closed</h3><div class="mb-6"><table class="mobile-table w-full text-left text-sm" id="table-active"><thead class="bg-green-50 text-green-900"><tr><th class="p-2">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="view-add-user" class="hidden flex justify-center fixed inset-0 z-50 bg-black/50 items-center p-4"><div class="glass w-full max-w-sm relative animate-scale-up"><button onclick="window.showDashboard()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-800 text-xl font-bold px-2">‚úï</button><h3 class="font-bold mb-4 text-lg">Add New User</h3><form onsubmit="event.preventDefault(); window.submitNewUser();" class="space-y-3"><input id="new-user-name" placeholder="Full Name" required><input id="new-user-email" placeholder="Email Address" required><select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select><input id="new-user-pass" type="password" placeholder="Set Password" required><button class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button></form></div></div>

        <div id="view-map" class="hidden fixed inset-0 z-50 bg-white flex flex-col md:flex-row"><div id="map-list" class="bg-white border-r relative z-10 shadow-xl overflow-y-auto"><div class="p-3 bg-orange-600 text-white font-bold flex justify-between items-center sticky top-0"><span>Permits Map</span><button onclick="window.showDashboard()" class="bg-white text-orange-600 px-2 rounded text-xs font-bold shadow">‚Üê Back</button></div><div id="map-list-content"></div></div><div id="map-container" class="relative"><div id="map" class="w-full h-full"></div></div></div>

        <div id="view-form" class="hidden">
            <div class="flex items-center gap-2 mb-2"><button onclick="window.showDashboard()" class="bg-white border text-gray-600 px-3 py-2 rounded-lg font-bold shadow-sm">‚Üê Back</button><div id="permit-header-display" class="flex-1 p-2 bg-blue-100 text-blue-800 rounded-lg font-bold text-center text-sm truncate"></div></div>
            <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden"><h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers</h3><div id="assigned-worker-audit" class="overflow-x-auto"></div></div>

            <form id="pf" class="space-y-4">
                <input type="hidden" id="PermitID" name="PermitID"><input type="hidden" id="Status" name="Status">
                <div class="glass"><h3 class="section-title">1. Permit Details</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div><div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div><div><label class="text-xs font-bold text-gray-500">Location (GPS)</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1"><button type="button" onclick="window.getGeo()" class="bg-orange-100 text-orange-600 px-4 rounded-lg font-bold border border-orange-200" id="btn-get-geo">üìç GPS</button></div></div><input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude"><div><label class="text-xs font-bold text-gray-500">Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div><div><label class="text-xs font-bold text-gray-500">Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div><div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom" onchange="window.checkDate()"></div><div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo" onchange="window.checkDate()"></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName"></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div><div><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div><div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly></div><div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div><div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div><div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div><div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div></div></div>
                
                <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50 hidden">
                    <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800"><input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5" onchange="document.getElementById('div-init-renewal').classList.toggle('hidden', !this.checked)"> Request 1st Renewal with Permit</label>
                    <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                        <div class="text-xs font-bold text-gray-500 mb-2">Renewal Details</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2"><input type="datetime-local" name="InitRenFrom" placeholder="From"><input type="datetime-local" name="InitRenTo" placeholder="To"></div>
                        <div class="grid grid-cols-3 gap-2"><input name="InitRenHC" placeholder="HC %"><input name="InitRenTox" placeholder="Tox"><input name="InitRenO2" placeholder="O2 %"></div>
                        <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                    </div>
                </div>

                <div class="glass" id="section-e"><h3 class="section-title">E. References</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No"><input name="JsaNo" id="JsaNo" placeholder="JSA No"><input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip"><input name="ContEquip" id="ContEquip" placeholder="Contractor Equip"><input name="WorkOrder" id="WorkOrder" placeholder="Work Order No"><input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"></div></div>
                <div class="glass"><h3 class="section-title">2. Checklists</h3><div id="checklists-wrapper" class="space-y-4"></div></div>
                <div class="glass" id="worker-select-section"><h3 class="section-title">Workers</h3><div id="worker-checkboxes" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div><div id="worker-readonly-table" class="hidden overflow-x-auto"><table class="mobile-table w-full text-xs text-left"><thead class="hidden md:table-header-group"><tr><th>Name</th><th>Gender</th><th>Age</th><th>Contractor</th></tr></thead><tbody class="divide-y"></tbody></table></div></div>
                <div class="glass" id="hazards-section"><h3 class="section-title">3. Hazards</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4" id="hazards-container"></div><div id="other-hazard-div" class="hidden mb-2"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div></div>
                
                <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500"><h3 class="section-title text-yellow-700">4. Reviewer</h3><div class="mb-4 hidden" id="iocl-reviewer-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label><div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div><button type="button" onclick="window.addIOCLRow('iocl-sup-container-rev')" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div><div class="mb-2 font-bold text-sm text-gray-600">PPE Required:</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4" id="ppe-container"></div><textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea><textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea></div>
                <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500"><h3 class="section-title text-green-700">5. Approval</h3><div class="mb-4 hidden" id="iocl-approver-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label><div id="iocl-sup-container-app" class="space-y-2 mt-2"></div><button type="button" onclick="window.addIOCLRow('iocl-sup-container-app')" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div><textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full"></textarea><div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div></div>
                <div id="iocl-sup-display-section" class="glass hidden"><h3 class="section-title">Authorized Supervisors</h3><table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit</th></tr></thead><tbody></tbody></table></div>

                <div id="renewals-section" class="glass hidden"><h3 class="section-title">Renewals</h3><div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg"><h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Action</h4><div class="flex gap-4"><label class="flex items-center gap-2 font-bold text-green-700"><input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5"> Approve Renewal</label><label class="flex items-center gap-2 font-bold text-red-700"><input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5"> Reject Renewal</label></div></div><div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200"><h4 class="font-bold text-yellow-800 text-sm uppercase">‚ö†Ô∏è Pending Renewal</h4><div class="text-sm grid grid-cols-1 gap-2 mt-2"><div class="flex justify-between border-b pb-1"><span>From:</span> <span id="disp-ren-from" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>To:</span> <span id="disp-ren-to" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>Gas:</span> <span id="disp-ren-gas" class="font-mono"></span></div><div><span>Prec:</span> <span id="disp-ren-prec"></span></div></div></div><div class="overflow-x-auto mb-4"><table class="mobile-table w-full text-xs text-left" id="table-renewals"><thead class="hidden md:table-header-group"><tr><th>Period</th><th>Gas & Precautions</th><th>Workers</th><th>Requester</th><th>Reviewer</th><th>Approver</th><th>Status</th></tr></thead><tbody id="renewals-list" class="divide-y"></tbody></table></div><div id="form-renewal" class="hidden p-4 bg-blue-50 mt-2 rounded-lg border border-blue-100"><div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-2"><input type="datetime-local" id="RenewalValidFrom"> <input type="datetime-local" id="RenewalValidTo"><div class="flex gap-2"><input id="RenewalHC" placeholder="HC %"> <input id="RenewalToxic" placeholder="Toxic"> <input id="RenewalOxygen" placeholder="O2 %"></div></div><div class="mt-3 border-t border-blue-200 pt-2 bg-white p-2 rounded"><label class="text-xs font-bold text-gray-500 block mb-1">Workers for this Renewal</label><div id="renewal-worker-select" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div></div><input id="RenewalPrec" placeholder="Precautions" class="w-full mb-2 mt-3"><button type="button" onclick="window.submitRenewal('approve')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow">Submit Renewal</button></div><div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded-lg border border-yellow-100"><textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea><div class="grid grid-cols-2 gap-2"><button type="button" onclick="window.submitRenewal('approve')" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow">Approve</button><button type="button" onclick="window.submitRenewal('reject')" class="bg-red-600 text-white py-3 rounded-lg font-bold shadow">Reject</button></div></div></div>
                <div id="closure-section" class="glass hidden"><h3 class="section-title">Closure</h3><label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-2 bg-red-50 rounded" id="lbl-site-restored"><input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5"> Site Restored & Cleaned</label><div id="div-closure-req" class="hidden space-y-2"><label class="text-xs font-bold text-gray-500">Requester Remarks</label><textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-req" class="text-xs text-gray-400 block text-right"></span></div><div id="div-closure-rev" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Reviewer Remarks</label><textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-rev" class="text-xs text-gray-400 block text-right"></span></div><div id="div-closure-app" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Approver Remarks</label><textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-app" class="text-xs text-gray-400 block text-right"></span></div></div>
                <div id="signature-history" class="glass hidden"><h3 class="section-title">History</h3><div class="grid grid-cols-1 gap-2 text-xs"><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div></div></div>
                
                <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden"><label class="flex items-start gap-3 p-2 cursor-pointer"><input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500"><span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms of IOCL Golden Safety Rules.</span></label></div>
                <div id="actions" class="mt-4 flex flex-col md:flex-row justify-end gap-2 sticky bottom-0 bg-white p-4 shadow-top z-50 border-t"></div>
            </form>
        </div>
    </div>

    <script>
        // --- ERROR LOGGER ---
        const debugEl = document.getElementById('debug-console');
        function log(msg) { debugEl.style.display='block'; debugEl.innerHTML += "<div>‚û§ " + msg + "</div>"; debugEl.scrollTop = debugEl.scrollHeight; }
        window.onerror = function(msg, url, line) { log("<span style='color:red; font-weight:bold;'>CRASH: " + msg + " (Line " + line + ")</span>"); return false; };
        window.onunhandledrejection = function(e) { log("<span style='color:red; font-weight:bold;'>ASYNC ERROR: " + e.reason + "</span>"); };

        const API = "/api";
        let currentUser = null; 
        let usersData = {}; 
        let mapInstance = null; 
        let chartS = null; 
        let chartT = null;
        let currentPermitWorkers = []; 
        let currentPermitId = null; 
        const loader = document.getElementById('loader');

        const CL_DATA = { A:["1. Equipment / Work Area inspected.", "2. Surrounding area checked, cleaned.", "3. Manholes/Sewers covered.", "4. Considered hazards.", "5. Equipment blinded/isolated.", "6. Equipment drained/depressurized.", "7. Equipment steamed/purged.", "8. Equipment water flushed.", "9. Access for Fire Tender.", "10. Iron Sulfide removed.", "11. Electrical isolation.", "12. Gas Test: HC/Toxic/O2.", "13. Firefighting system available.", "14. Area cordoned off.", "15. CCTV monitoring.", "16. Ventilation/Lighting."], B:["1. Means of exit.", "2. Standby personnel.", "3. Checked for oil/gas trapped.", "4. Spark shield.", "5. Grounding.", "6. Standby for confined space.", "7. Communication.", "8. Rescue equipment.", "9. Space cooled.", "10. Inert gas.", "11. ELCB/Earthing.", "12. Cylinders outside.", "13. Spark arrestor.", "14. Welding machine safe.", "15. Height permit taken."], C:["1. Spark elimination system on vehicle."], D:["1. Shoring/sloping provided.", "2. Soil at safe distance.", "3. Access provided.", "4. No heavy vehicle movement."] };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        document.addEventListener("DOMContentLoaded", () => { window.loadUsers(); renderUI(); });

        async function apiCall(ep, meth="GET", body=null) {
            loader.style.display = 'flex';
            try {
                // log("API Call: " + ep);
                const opts={method:meth,headers:{'Content-Type':'application/json'}};
                if(body)opts.body=JSON.stringify(body);
                const res=await fetch(API+ep,opts); 
                if(!res.ok) throw new Error("HTTP " + res.status);
                const json = await res.json();
                return json;
            } catch(e) {
                log("<span style='color:red'>API Error (" + ep + "): " + e.message + "</span>");
                throw e;
            } finally { loader.style.display = 'none'; }
        }

        // TOGGLES & RENDER
        window.toggleSection = function(sec, val) { const radios = document.querySelectorAll(`input[name^="${sec}_Q"][value="${val}"]`); radios.forEach(r => r.checked = true); }
        function renderUI() {
            let h = '';
            ['A','B','C','D'].forEach(sec => {
                h += `<div class="glass p-3"><div class="flex justify-between items-center border-b pb-1 mb-2"><div class="font-bold text-orange-700">SECTION ${sec}</div><div class="flex gap-2 text-xs items-center bg-orange-50 p-1 rounded"><label><input type="radio" name="Master_${sec}" value="Yes" checked onchange="window.toggleSection('${sec}', 'Yes')"> Yes</label><label><input type="radio" name="Master_${sec}" value="NA" onchange="window.toggleSection('${sec}', 'NA')"> NA</label><label><input type="radio" name="Master_${sec}" value="No" onchange="window.toggleSection('${sec}', 'No')"> No</label></div></div>`;
                h += CL_DATA[sec].map((t, i) => {
                    const id = `${sec}_Q${i+1}`;
                    let remInput = `<input name="${id}_Detail" placeholder="Rem" class="text-sm mt-2 w-full border-gray-200">`;
                    if(sec==='A' && i===11) remInput = `<div class="flex gap-1 mt-2"><input name="GP_Q12_HC" placeholder="HC %"><input name="GP_Q12_ToxicGas" placeholder="Tox"><input name="GP_Q12_Oxygen" placeholder="O2 %"></div>`;
                    return `<div class="mb-4 pb-2 border-b border-gray-100 last:border-0"><div class="text-sm font-medium text-gray-800 mb-2">${t}</div><div class="flex justify-between items-center bg-gray-50 p-2 rounded"><div class="flex gap-4"><label><input type="radio" name="${id}" value="Yes" checked> Yes</label><label><input type="radio" name="${id}" value="NA"> NA</label><label><input type="radio" name="${id}" value="No"> No</label></div></div>${remInput}</div>`;
                }).join('');
                h += `</div>`;
            });
            document.getElementById('checklists-wrapper').innerHTML = h;
            document.getElementById('hazards-container').innerHTML = HAZARDS.map(z => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="H_${z.replace(/ /g,'')}" value="Y" ${z==='Others'?'onchange="document.getElementById(\'other-hazard-div\').classList.toggle(\'hidden\',!this.checked)"':''}> <span class="text-sm">${z}</span></label>`).join('');
            document.getElementById('ppe-container').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y"> <span class="text-sm">${p}</span></label>`).join('');
        }

       window.loadUsers = async function() { 
            try { const u = await apiCall('/users'); usersData = u; document.getElementById("login-role").value = "Requester"; window.loadUserNames(); } catch (e) { log(e.message); } 
        }
        window.loadUserNames = function() { 
            const role = document.getElementById("login-role").value; 
            const sel = document.getElementById("login-name"); 
            sel.innerHTML = (usersData[role+'s']||[]).map(u => `<option value="${u.email}">${u.name}</option>`).join(''); 
            sel.disabled = false; 
        }
        window.handleLogin = async function() { 
            const r=document.getElementById("login-role").value; const n=document.getElementById("login-name").options[document.getElementById("login-name").selectedIndex].text; const e=document.getElementById("login-name").value; const p=document.getElementById("login-password").value; 
            const res=await apiCall('/login','POST',{role:r,name:e,password:p}); 
            if(res.success){ currentUser={...res.user, name:n}; document.getElementById("view-login").classList.add('hidden'); document.getElementById("app-container").classList.remove('hidden'); document.getElementById("user-info").innerText=`${n} (${r})`; updateRoleUI(); loadDashboard(); } else alert("Invalid Login"); 
        }
        
        function updateRoleUI() { 
            if(currentUser.Role==='Requester') { 
                document.getElementById("btn-new-permit").classList.remove('hidden'); 
                document.getElementById("btn-add-worker").classList.remove('hidden'); 
                document.getElementById("btn-header-map").classList.add('hidden'); 
            } 
            if(currentUser.Role!=='Requester') { 
                document.getElementById("btn-view-map").classList.remove('hidden'); 
                document.getElementById("btn-download-excel").classList.remove('hidden'); 
                document.getElementById("charts-container").classList.remove('hidden'); 
                document.getElementById("btn-header-map").classList.remove('hidden'); 
                loadStats(); 
                if(currentUser.Role==='Approver') document.getElementById("btn-add-user").classList.remove('hidden'); 
            } 
        }

        async function loadStats() { 
            if(typeof Chart === 'undefined') { log("Chart.js not loaded!"); return; }
            const res=await apiCall('/stats','POST'); 
            if(chartS)chartS.destroy(); if(chartT)chartT.destroy(); 
            chartS=new Chart(document.getElementById('chartStatus'),{type:'doughnut',data:{labels:Object.keys(res.statusCounts),datasets:[{data:Object.values(res.statusCounts)}]}}); 
            chartT=new Chart(document.getElementById('chartType'),{type:'bar',data:{labels:Object.keys(res.typeCounts),datasets:[{label:'Types',data:Object.values(res.typeCounts)}]}}); 
        }

        window.toggleOtherID = function() { const val = document.getElementById("w-id-type").value; document.getElementById("w-id-type-other").classList.toggle("hidden", val !== "Other"); }
        window.toggleWorkerMode = function() { const dash = document.getElementById("view-dashboard"); const work = document.getElementById("view-worker-management"); document.getElementById("view-map").classList.add('hidden'); if(dash.classList.contains('hidden')) { dash.classList.remove('hidden'); work.classList.add('hidden'); } else { dash.classList.add('hidden'); work.classList.remove('hidden'); loadWorkers('dashboard'); } }
        window.openWorkerForm = function(act, data=null) { window.currentWorkerAction = act; document.getElementById('worker-form-container').classList.remove('hidden'); if(act==='create') { document.getElementById('w-id').value=''; document.querySelectorAll('#worker-form-container input').forEach(i=>i.value=''); } else if(data) { document.getElementById('w-id').value=data.WorkerID; document.getElementById('w-name').value=data.Name; /* Populate others */ } }
        async function loadWorkers(context) { const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); if(context === 'permit_dropdown') { const con = document.getElementById('worker-checkboxes'); con.innerHTML = res.map(w => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5"> <span class="font-bold">${w.Name}</span> <span class="text-xs text-gray-500">(${w.Age})</span></label>`).join(''); } else { const t = document.querySelector('#table-workers tbody'); t.innerHTML = res.map(w => `<tr><td data-label="Name" class="font-bold text-blue-600">${w.Name}</td><td data-label="Father">${w.Father}</td><td data-label="ID Details">${w.IDType || 'ID'}: ${w.ID}</td><td data-label="Address/Contact">${w.Address}<br><span class="text-xs text-blue-600">${w.Contact}</span></td><td data-label="Requestor" class="font-bold text-indigo-600">${w.RequestorName || 'Unknown'}</td> <td data-label="Status"><span class="px-2 py-1 rounded text-xs font-bold ${w.Status==='Approved'?'bg-green-100 text-green-800':(w.Status==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800')}">${w.Status}</span>${w.ApprovedBy ? `<div class="text-[10px] mt-1 text-green-700">App: ${w.ApprovedBy}<br>${w.ApprovedAt}</div>` : ''}</td><td data-label="Action">${(currentUser.Role !== 'Requester' && w.Status.includes('Pending')) ? `<button onclick="window.workerAction('${w.WorkerID}','approve')" class="text-green-600 font-bold border p-1 rounded hover:bg-green-50">Approve</button> <button onclick="window.workerAction('${w.WorkerID}','reject')" class="text-red-600 font-bold border p-1 rounded hover:bg-red-50 ml-2">Reject</button>` : ''}${(currentUser.Role==='Requester' && w.Status==='Approved') ? `<button onclick='window.openWorkerForm("edit_request", ${JSON.stringify(w)})' class="text-blue-600 font-bold mr-2">Edit</button> <button onclick="window.workerAction('${w.WorkerID}','delete')" class="text-red-600 font-bold">Del</button>` : ''}</td></tr>`).join(''); } }
        window.workerAction = async function(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.name}); loadWorkers('dashboard'); }
        window.saveWorker = async function(act) { 
            const idTypeRaw = document.getElementById("w-id-type").value; const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw; 
            if(parseInt(document.getElementById("w-age").value) < 18) { alert("Worker must be 18+"); return; }
            const body = { Action: act, Role: currentUser.Role, RequestorEmail: currentUser.Email, WorkerID: document.getElementById('w-id').value, ApproverName: currentUser.name, RequestorName: currentUser.name, Details: { Name:document.getElementById("w-name").value, Father:document.getElementById("w-father").value, Address:document.getElementById("w-address").value, Contact:document.getElementById("w-contact").value, ID:document.getElementById("w-idcard").value, Gender:document.getElementById("w-gender").value, Age:document.getElementById("w-age").value, IDType: idTypeFinal } }; 
            const res = await apiCall('/save-worker', 'POST', body); if(res.success) { alert("Saved"); loadWorkers('dashboard'); document.getElementById('worker-form-container').classList.add('hidden'); } else alert(res.error); 
        }

        async function loadDashboard() { 
            // log("Loading Dashboard...");
            const res = await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email}); 
            // log("Dashboard Data: " + res.length + " permits found.");
            
            const tP=document.querySelector('#table-pending tbody'), tA=document.querySelector('#table-active tbody');
            tP.innerHTML=""; tA.innerHTML=""; 
            res.forEach(p => { 
                let pendingWith = "-"; 
                if(p.Status.includes('Review')) pendingWith = p.ReviewerEmail ? p.ReviewerEmail.split('@')[0] : '-'; 
                if(p.Status.includes('Approval')) pendingWith = p.ApproverEmail ? p.ApproverEmail.split('@')[0] : '-'; 
                const color = p.Status.includes('Pending') ? 'text-red-600' : (p.Status==='Active' ? 'text-green-600' : 'text-gray-600'); 
                const row = `<tr onclick="window.openPermit('${p.PermitID}')"><td data-label="ID" class="font-bold text-blue-600">${p.PermitID}</td><td data-label="Type">${p.WorkType}</td><td data-label="Loc">${p.LocationUnit}</td><td data-label="Status" class="font-bold ${color}">${p.Status}</td><td data-label="Action"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">OPEN</span></td></tr>`; 
                let isAction = false; 
                if(currentUser.Role === 'Reviewer' && p.Status.includes('Review') && p.ReviewerEmail === currentUser.Email) isAction = true; 
                if(currentUser.Role === 'Approver' && p.Status.includes('Approval') && p.ApproverEmail === currentUser.Email) isAction = true; 
                if(currentUser.Role === 'Requester' && p.Status.includes('Pending')) isAction = true; 
                
                if(isAction) tP.innerHTML += row; else tA.innerHTML += row;
            }); 
        }

        // --- OPEN PERMIT DEBUGGED ---
        window.openPermit = async function(id) {
            try {
                const p = await apiCall('/permit-data', 'POST', {permitId:id});
                currentPermitId = id;
                window.currentPermitIOCLData = p.IOCLSupervisors || []; 

                document.getElementById("permit-header-display").innerText = `${id} | ${p.Status}`;
                
                // --- SAFE JSON PARSING ---
                try {
                    let workersArr = [];
                    if(p.SelectedWorkers) {
                        if(Array.isArray(p.SelectedWorkers)) workersArr = p.SelectedWorkers;
                        else if(typeof p.SelectedWorkers === 'string') workersArr = JSON.parse(p.SelectedWorkers);
                    }
                    currentPermitWorkers = workersArr;
                    // Render audit table
                    if(document.getElementById("assigned-worker-audit")) {
                        document.getElementById("assigned-worker-audit").innerHTML = `<table class="mobile-table w-full text-xs"><thead><tr><th>Name</th><th>ID</th></tr></thead><tbody>${workersArr.map(w=>`<tr><td>${w.Name}</td><td>${w.ID}</td></tr>`).join('')}</tbody></table>`;
                    }
                } catch(e) { log("Error parsing workers: " + e.message); }

                // --- POPULATE FORM ---
                document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => {
                    if(e.type==='radio'){ if(e.value===p[e.name]) e.checked=true; } 
                    else if(e.type==='checkbox'){ e.checked=(p[e.name]==='Y'); } 
                    else { if(p[e.name]) e.value=p[e.name]; }
                    e.disabled=true; 
                });

                // --- SHOW VIEW ---
                document.getElementById("view-dashboard").classList.add('hidden'); 
                document.getElementById("view-form").classList.remove('hidden');
                
                // Show Update/Review Buttons if needed
                const r = currentUser.Role; const s = p.Status;
                let btns = "";
                if(s === 'Pending Review' && r==='Requester') {
                    document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e=>e.disabled=false);
                    btns=`<button type="button" onclick="window.savePermit()" class="w-full bg-blue-600 text-white px-3 rounded-lg font-bold shadow-lg">Update Permit</button>`;
                } else if(s === 'Pending Review' && r==='Reviewer') {
                    document.getElementById("fs-reviewer-section").classList.remove('hidden');
                    document.querySelectorAll('#fs-reviewer-section *, #hazards-section input').forEach(e=>e.disabled=false);
                    btns=`<button type="button" onclick="window.upd('reject')" class="bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('review')" class="bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Submit Review</button>`;
                } else if(s === 'Pending Approval' && r==='Approver') {
                    document.getElementById("fs-approver-section").classList.remove('hidden');
                    document.getElementById("Approver_Remarks").disabled=false;
                    btns=`<button type="button" onclick="window.upd('reject')" class="bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve')" class="bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Approve</button>`;
                } else {
                    btns += `<a href="${API}/download-pdf/${id}" target="_blank" class="bg-gray-700 text-white px-6 py-3 rounded-lg font-bold shadow flex-1 text-center">Download PDF</a>`;
                }
                
                document.getElementById("actions").innerHTML = btns;

            } catch (e) {
                log("<span style='color:red'>CRITICAL ERROR OPENING PERMIT: " + e.message + "</span>");
                console.error(e);
            }
        }

        window.showMap = function() { 
            if(typeof google === 'undefined') { log("Google Maps not loaded (Check API Key)"); return; }
            document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-map").classList.remove('hidden'); loadMapData(); 
        }
        async function loadMapData() { 
            const p = await apiCall('/map-data', 'POST'); 
            if(!mapInstance) mapInstance=new google.maps.Map(document.getElementById("map"),{center:{lat:22.57,lng:88.36},zoom:5}); 
            // Marker logic omitted for brevity
        }
        
        window.showNewPermit = async function() { 
            document.getElementById("pf").reset(); currentPermitId=null; 
            document.getElementById("Status").value="New"; document.getElementById("permit-header-display").innerText = "New Permit"; 
            document.getElementById("permit-worker-audit-display").classList.add("hidden"); 
            document.getElementById("iocl-sup-display-section").classList.add('hidden'); 
            document.getElementById("iocl-reviewer-wrapper").classList.add('hidden'); 
            document.getElementById("iocl-approver-wrapper").classList.add('hidden'); 
            document.getElementById("first-renewal-decision").classList.add('hidden'); 
            
            const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
            if(rS && aS) { rS.innerHTML=""; aS.innerHTML=""; if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); } } 
            document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false); 
            
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) { el.value = val; } }; 
            safeSet("RequesterName", currentUser.name); safeSet("Vendor", currentUser.name); document.getElementById("Vendor").readOnly=true; document.getElementById("RequesterName").disabled=false; 
            await loadWorkers('permit_dropdown'); document.querySelectorAll('#worker-checkboxes input').forEach(c => c.disabled = false); document.getElementById('worker-checkboxes').classList.remove('hidden'); document.getElementById('worker-readonly-table').classList.add('hidden'); document.getElementById("fs-reviewer-section").classList.add('hidden'); document.getElementById("fs-approver-section").classList.add('hidden'); document.getElementById("renewals-section").classList.add('hidden'); document.getElementById("closure-section").classList.add('hidden'); 
            
            const gsrEl = document.getElementById("gsr-check");
            gsrEl.checked = false;
            gsrEl.disabled = false;
            document.getElementById("gsr-container").classList.remove('hidden');

            document.getElementById("chk-init-renewal").checked = false;
            document.getElementById("div-init-renewal").classList.add('hidden');
            document.getElementById("init-renewal-wrapper").classList.remove('hidden'); 
            
            document.getElementById("actions").innerHTML = `<button type="button" onclick="window.savePermit()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg">Submit Permit</button>`; 
            document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-form").classList.remove('hidden'); 
        }

        window.savePermit = async function() { 
            if(!document.getElementById('gsr-check').checked) {
                alert("You must accept the Golden Safety Rules terms to proceed.");
                return;
            }
            // Simple validation logic here...
            document.getElementById('loader').style.display = 'flex'; 
            try { 
                const formData = new FormData(document.getElementById("pf"));
                const dataObj = {};
                formData.forEach((value, key) => dataObj[key] = value);
                
                document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                    if (c.name && !c.name.startsWith('Worker_')) { dataObj[c.name] = c.checked ? "Y" : "N"; }
                });
                dataObj.GSR_Accepted = "Y";
                const selectedWorkers = []; 
                document.querySelectorAll('#worker-checkboxes input:checked').forEach(c => { selectedWorkers.push(JSON.parse(c.value)); }); 
                dataObj.SelectedWorkers = selectedWorkers; 
                
                if(currentUser && currentUser.Email) { dataObj.RequesterEmail = currentUser.Email; }
                if(currentPermitId) dataObj.PermitID = currentPermitId; 
                
                const res = await apiCall('/save-permit', 'POST', dataObj);
                if(res.success){ alert("Saved successfully: " + res.permitId); showDashboard(); } else { alert("Error: " + (res.error || "Unknown Error")); }
            } catch (e) { alert("Submission Failed: " + e.message); } finally { document.getElementById('loader').style.display = 'none'; } 
        };
        window.checkDate = function() { const vf=new Date(document.getElementById("ValidFrom").value); const vt=new Date(document.getElementById("ValidTo").value); if(vf && vt) { if(vt <= vf) { alert("End time must be greater than Start time"); document.getElementById("ValidTo").value=""; return; } if((vt-vf)/(1000*60*60*24) > 7) { alert("Max 7 Days"); document.getElementById("ValidTo").value=""; } } }
        window.upd = async function(act) {
            // (Simplified update logic)
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
            const body = { 
                PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.name,
                comment: (currentUser.Role==='Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks")),
            };
            // Add specific logic for Reviewer data capture...
            if(currentUser.Role === 'Reviewer' && act === 'review') {
                 body.Reviewer_Remarks = getVal("Reviewer_Remarks");
                 body.AdditionalPrecautions = getVal("AdditionalPrecautions");
                 // Capture hazards/PPE again if needed
                 document.querySelectorAll('#hazards-section input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                 document.querySelectorAll('#ppe-container input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
            }
            if(currentUser.Role === 'Approver') { body.Approver_Remarks = getVal("Approver_Remarks"); }

            const res = await apiCall('/update-status', 'POST', body);
            if(res.success) showDashboard(); else alert(res.error);
        }
        window.submitRenewal = async function(act) {
             const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
             const body = { PermitID: currentPermitId, userRole: currentUser.Role, userName: currentUser.name, action: act, RenewalValidFrom: getVal("RenewalValidFrom"), RenewalValidTo: getVal("RenewalValidTo"), hc: getVal("RenewalHC"), toxic: getVal("RenewalToxic"), oxygen: getVal("RenewalOxygen"), precautions: getVal("RenewalPrec"), rejectionReason: getVal("RenewalRemark") };
             const res = await apiCall('/renewal', 'POST', body);
             if(res.success) { alert("Done"); showDashboard(); } else alert(res.error);
        }
    </script>
</body>
</html>
